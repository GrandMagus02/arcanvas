---
description: Core package architecture and WebGL/Canvas engine technical rules
globs: packages/core/**/*
alwaysApply: false
---

# Core Package Architecture

## Package Purpose

`@arcanvas/core` is a minimal, extensible rendering engine designed for building Figma-like editors, Photoshop/Aseprite web alternatives, and large-scale 2D/3D worlds. It provides essential rendering, scene graph, and plugin infrastructure with a focus on modularity and backend abstraction.

## Design Principles

1. **Minimal Core**: Only essential engine functionality.
2. **Extensibility First**: Plugin system and interface-based design for feature expansion.
3. **Separation of Concerns**: Clear boundaries between rendering, scene, and application logic.
4. **Backend Agnostic**: Rendering is abstracted via `IRenderBackend` (WebGL2, Canvas2D, WebGPU ready).
5. **Dual Scene Support**: Distinct `Stage` (UI/Editor) and `WorldScene` (Large scale/Game) graphs.

## Extensibility & Variety Guidelines

To ensure the engine remains flexible and supports a variety of use cases (Editors, Games, Visualizations):

1.  **Interface over Implementation**: Always refer to interfaces (e.g., `IRenderBackend`, `ICameraController`) in core logic. This allows swapping implementations (e.g., switching to WebGPU or a custom camera control).
2.  **Plugin-Driven Features**: Core should only contain what *everyone* needs. Specific tools (Brush, Select), Filters, and UI panels MUST be plugins.
3.  **Backend Agnostic Shaders**: When possible, design materials/shaders to work with the `ShaderProvider` abstraction to support future backends.
4.  **Dual-Mode Support**: Always consider if a feature belongs in the "Screen Space" (`Stage`) or "World Space" (`WorldScene`). Don't couple logic to just one if it applies to both.
5.  **Modular Systems**: Systems (Render, Scene, Event) should be loosely coupled. Use `Arcanvas` as the hub but avoid direct cross-system dependencies where possible.

## Component Architecture

### Arcanvas (Application Root)

- **Responsibilities**: Lifecycle, canvas management, subsystem coordination, event hub, plugin host.
- **State**: `canvas`, `options`, `stage` (or `world`), `renderSystem`, `plugins`, `events`.
- **Rule**: Thin orchestrator only. No business logic. Delegates to `RenderSystem`, `SceneSystem`, `PluginSystem`.

### Scene Graphs

#### 1. Stage (UI/Editor)
- **Purpose**: Hierarchical 2D/UI composition, standard scene graph.
- **Node Base**: `id`, `name`, `parent`, `children`, `transform`.
- **Stage**: Root node, extends `Node`, holds canvas reference.
- **Usage**: Editors, overlays, standard object hierarchies.

#### 2. WorldScene (Large Scale)
- **Purpose**: Infinite/Large worlds (Games, Maps).
- **Structure**: Flat or partitioned collection of `WorldRenderObject`.
- **Coordinates**: Uses high-precision coordinates.
- **Floating Origin**: Works with `WorldCamera` and `WorldRenderer` to handle floating origin rendering for precision.

### Rendering System

#### Rendering Abstraction
- **IRenderBackend**: Low-level interface (`beginFrame`, `drawMesh`, `endFrame`, `prepareMesh`).
- **Implementations**:
    - `WebGLBackend`: Standard WebGL2 implementation.
    - `Canvas2DBackend`: Fallback or specific 2D rendering.
    - `WebGPUBackend`: Future high-performance backend.

#### Renderers
- **Renderer**: Standard renderer for `Scene`/`Stage`.
- **WorldRenderer**: Specialized renderer for `WorldScene` that handles camera-relative transforms (floating origin).
- **RenderSystem**: High-level system in `Arcanvas` that manages the `IRenderBackend` and appropriate `Renderer`.

### Camera System

- **Camera**: Standard camera for `Stage` (View/Projection matrices).
- **WorldCamera**: High-precision camera for `WorldScene`.
- **CameraManager**: Manages multiple cameras.
- **Controllers**: `ICameraController` implementations (e.g., `Camera2DController`) handle input and movement logic.
- **Rule**: Cameras are reactive to resize. Projection is separated from input logic (Controllers).

### Event System

- **EventBus<T>**: Typed event emitter.
- **Standard Events**: `resize`, `focus`, `blur`, `camera:move`, `layer:dirty`.
- **Rule**: Use typed event keys.

### Plugin System

- **PluginManager**: Manages lifecycle (`setup`, `destroy`).
- **Plugin<T>**: Base class with access to `Arcanvas`.
- **Types**: `Tool`, `Filter`, `UI`, `System`.
- **Rule**: Plugins are the primary mechanism for adding non-core features.

## WebGL/Backend Technical Rules

### Resource Management
- **Buffers/Textures**: Created via Backend API.
- **Cleanup**: explicit `dispose` or `destroy` methods are mandatory.
- **Caching**: `ProgramCache`, `StateCache` (internal to Backend) should be used to minimize driver overhead.

### State Management
- **Batching**: The Backend implementation should handle state batching (blend modes, shaders).
- **Stateless Higher Level**: High-level code (Meshes, Nodes) should not make direct GL calls. They should describe *what* to draw via `Renderable` interfaces.

### Shaders & Materials
- **Materials**: Define visual properties and shader requirements.
- **ShaderProvider**: Resolves shader source code (support for different shader languages for WebGL/WebGPU).
- **Uniforms**: Handled by the Material system, passed to Backend.

## File Structure

```
packages/core/src/
├── core/                   # App root (Arcanvas)
├── infrastructure/         # Base systems (Canvas, Events)
├── systems/                # Top-level systems (Render, Scene, Plugin)
├── rendering/
│   ├── engine/             # Core rendering logic
│   │   ├── backends/       # WebGL, Canvas2D, WebGPU implementations
│   │   └── IRenderBackend.ts
│   ├── graph/              # RenderGraph (passes)
│   └── gpu/                # Resource management
├── scene/                  # Standard Scene Graph (Node, Stage)
│   └── WorldScene.ts       # Large-scale world scene
├── camera/                 # Camera & Controllers
├── meshes/                 # Concrete Mesh implementations
├── document/               # 2D Document Model
├── plugins/                # Plugin system
└── utils/                  # Math & Helpers
```

## Dependencies

- **Layered Architecture**: `utils` < `infrastructure` < `rendering`/`scene`/`camera` < `systems` < `core` (Arcanvas).
- **Strict Direction**: Higher layers import lower layers. Lower layers NEVER import higher layers.
